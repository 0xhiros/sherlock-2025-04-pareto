# TABLE OF CONTENTS
1. [Introduction](#introduction)  
2. [Architecture Overview](#architecture-overview)  
   2.1 [ParetoDollar (Core Mint/Redeem)](#21-paretodollar-core-mintredeem)  
   2.2 [ParetoDollarQueue (Collateral & Yield-Management Queue)](#22-paretodollarqueue-collateral--yield-management-queue)  
   2.3 [ParetoDollarStaking (Staking & Yield Distribution)](#23-paretodollarstaking-staking--yield-distribution)  
3. [Roles & Permissions](#roles--permissions)  
4. [System Flows](#system-flows)  
   4.1 [User Flow (Minting, Redeeming, & Staking)](#41-user-flow-minting-redeeming--staking)  
   4.2 [Manager Flow (Allocations, Epochs, & Yield)](#42-manager-flow-allocations-epochs--yield)  
5. [Contract API References](#contract-api-references)  
   5.1 [ParetoDollar](#51-paretodollar)  
   5.2 [ParetoDollarQueue](#52-paretodollarqueue)  
   5.3 [ParetoDollarStaking](#53-paretodollarstaking)  
6. [Collateral & Yield Sources](#collateral--yield-sources)  
   6.1 [Collateral Tracking](#61-collateral-tracking)  
   6.2 [Yield Source Integration](#62-yield-source-integration)  
   6.3 [Adding & Removing Yield Sources](#63-adding--removing-yield-sources)  
7. [FAQs & Implementation Details](#faqs--implementation-details)

---

## Introduction
Pareto USP is a synthetic dollar (token symbol "USP") backed primarily by Pareto Credit Vaults and optionally other ERC4626-compliant strategies. It aims to maintain a 1:1 peg with USD. The system uses:

- **ParetoDollar (main contract)**: Mints and redeems USP in exchange for stablecoin collaterals.  
- **ParetoDollarQueue (queue contract)**: Manages collateral distribution to and from various yield sources (e.g. credit vaults, ERC4626 strategies) and tracks user redemption requests.  
- **ParetoDollarStaking (staking contract)**: Allows users to stake their USP for sUSP (an ERC4626 token) and earn yield generated by the underlying vaults.

This documentation provides an in-depth overview of how these contracts operate and interact, intended for both auditors and integrators wishing to connect with or build upon the Pareto USP system.

---

## Architecture Overview

### 2.1 ParetoDollar (Core Mint/Redeem)
The `ParetoDollar` contract is responsible for:
- Minting new USP tokens in exchange for whitelisted collaterals (e.g. USDC, USDS, USDT).  
- Burning USP tokens when a user requests redemption (redemption requests are then managed by `ParetoDollarQueue`).  
- Enforcing any required permission checks (e.g. KYC checks, optional whitelisting).  
- Interacting with the Queue for deposit and redemption logic.  
- Tracking collateral assets (collateral data is stored and updated here).

### 2.2 ParetoDollarQueue (Collateral & Yield-Management Queue)
The Queue contract acts as an intermediary for the system’s collateral. Specifically, it:  
- Holds stablecoin collateral on behalf of USP holders.  
- Routes capital to various yield strategies (Pareto Credit Vaults or ERC4626 vaults).  
- Maintains a notion of “epochs.” Each epoch groups user redemption requests.  
- Manages requests (`requestRedeem`) coming from `ParetoDollar`, and processes them in aggregated (batched) form.  
- Exposes manager functions to deposit and withdraw from yield strategies, to handle partial or full redemption requests, and eventually fulfill user redemptions after an epoch ends.

### 2.3 ParetoDollarStaking (Staking & Yield Distribution)
USP holders can stake their USP to receive sUSP. The sUSP:  
- Is an interest-bearing representation of staked USP.  
- Gains yield from the interest generated by credit vaults / yield sources.  
- Gains yield automatically via manager calls to `depositYield` (representing the yield) into the staking contract.  
- Allows users to deposit and withdraw (stake/unstake) at any time.

---

## Roles & Permissions
The Pareto USP system requires multiple key roles:

- **OWNER (Admin)**: Has ultimate control (via OpenZeppelin’s Ownable or AccessControl) to add or remove yield sources, set system parameters, or set manager addresses.  
- **MANAGER**: Responsible for day-to-day yield source operations, such as deposits/withdrawals, requesting redemption from credit vaults, finalizing epochs, and also rebalancing funds between yield sources if needed (even without active redemption requests).  
- **PAUSER**: Can pause certain system functions in an emergency.  

---

## System Flows

### 4.1 User Flow (Minting, Redeeming, & Staking)

#### (a) Minting
1. User calls `mint` on `ParetoDollar`, providing an approved stablecoin collateral (e.g. USDC).  
2. `ParetoDollar` receives the collateral and mints USP to the user.  
3. `ParetoDollar` deposit funds into `ParetoDollarQueue` automatically.

#### (b) Redeeming (Requests)
1. User calls `requestRedeem` on `ParetoDollar` with the amount of USP they want to redeem.  
2. `ParetoDollar` burns the USP and calls `requestRedeem` on `ParetoDollarQueue`.  
3. The user waits for the manager to free up enough collateral from yield sources.  
4. Once the manager finalizes the epoch and withdraws enough funds, the user can call `claimRedeemRequest` on `ParetoDollar` to receive stablecoins.

#### (c) Staking
1. User calls `deposit` on `ParetoDollarStaking` with USP.  
2. The user receives sUSP, an interest-bearing token.  
3. As yield accumulates (the manager calls `depositYield` on the Queue), new USP tokens representing yield are minted and deposited into `ParetoDollarStaking`.  
4. Users can call `withdraw` on `ParetoDollarStaking` at any time to get USP back at the updated ratio.

### 4.2 Manager Flow (Allocations, Epochs, & Yield)

#### (a) Allocating Funds to Yield
1. Manager calls `depositFunds` on `ParetoDollarQueue`, specifying which yield source(s) and method(s) to execute.  
2. The Queue moves stablecoins to the target yield source (e.g. depositing to a credit vault or an ERC4626 vault).

#### (b) Handling Redemption Requests
1. The manager “closes” an epoch by calling `stopEpoch`, preventing additional redemption requests for that epoch.  
2. The manager calls `callWhitelistedMethods` or `redeemFunds` to pull funds from yield sources, targeting the amounts needed for that epoch’s redemption requests.  
3. Once funds arrive back to the Queue, users can claim their redemption requests.

#### (c) Rebalancing & Distributing Yield
1. The manager can rebalance funds between yield sources if needed (e.g., calling `redeemFunds` from one source and `depositFunds` into another) with no active redemption requests.  
2. The manager calls `depositYield` on `ParetoDollarQueue` to capture realized yield.  
3. The Queue mints new USP representing the yield and deposits it into `ParetoDollarStaking`, increasing the sUSP/USP exchange rate.

---

## Contract API References

### 5.1 ParetoDollar
**Core methods** (user-facing, though subject to role checks if permissioned):  
- **`mint(address collateral, uint256 amount)`**  
  Mints USP in exchange for a specified `amount` of `collateral`.  
- **`requestRedeem(uint256 amount)`**  
  Burns USP and instructs `ParetoDollarQueue` to reserve that amount in the current epoch’s redemption queue.  
- **`claimRedeemRequest(uint256 epoch)`**  
  After the epoch is finalized, transfers the appropriate collateral back to the user.  
- **`getCollaterals()`**  
  Returns the list of approved stablecoin collaterals.

### 5.2 ParetoDollarQueue

#### 5.2.1 Core Data Structures & Storage
- **`epochNumber`** – Current epoch index.  
- **`totReservedWithdrawals`** – Total USP burned (redemption requests) not yet redeemed by users.
- **`epochPending[epoch]`** – Total USP redemption requests in a given epoch not yet fullfilled by the manager.
- **`userWithdrawalsEpochs[user][epoch]`** – Amount a specific user requested in that epoch.
- **`allYieldSources`** – List of all authorized yield sources in the system.

#### 5.2.2 Lifecycle Methods (Initialization & Epoch Management)
- **`initialize(address _admin, address _pauser, address _par, address _sPar, address[] memory _managers)`**  
  Sets up roles, references to `par` and `sPar`, initial allowances, etc.  
- **`stopEpoch()`**  
  Closes the current epoch and increments `epochNumber`. Manager-only. Fails if unfilled requests remain.

#### 5.2.3 Redeem Request & Claim
- **`requestRedeem(address user, uint256 amount)`**  
  Only callable by `ParetoDollar`. Updates `epochPending` and `totReservedWithdrawals`.  
- **`claimRedeemRequest(address user, uint256 epoch)`**  
  Only callable by `ParetoDollar` after funds have been withdrawn for that epoch.

#### 5.2.4 Depositing & Redeeming from Yield Sources
- **`depositFunds(address[] memory _sources, bytes4[] memory _methods, bytes[] calldata _args)`**  
  Manager-only. Calls whitelisted deposit methods on yield sources.  
- **`redeemFunds(address[] calldata _sources, bytes4[] calldata _methods, bytes[] calldata _args, uint256 epoch)`**  
  Manager-only. Redeems funds from yield sources to fulfill redemption requests in `epoch`.  
- **`callWhitelistedMethods(address[] calldata, bytes4[] calldata, bytes[] calldata)`**  
  Manager-only. Executes arbitrary whitelisted function signatures on yield sources (e.g., request for withdrawal on credit vaults, swap of USDC to USDS via PSM).

#### 5.2.5 Additional Manager Methods
- **`depositYield()`**  
  Manager-only. Mints new USP for net profit and deposits it into `sPar`.  
- **`addYieldSource(address _source, ...)`**  
  Owner-only. Adds an authorized yield source with a vault type and whitelisted methods.  
- **`removeYieldSource(address _source)`**  
  Owner-only. Removes a yield source once its balance is zero.

#### 5.2.6 Additional View Methods
- **`getUnlentBalanceScaled()`**  
  Returns the total balance of all collaterals in the Queue, scaled to 18 decimals.
- **`getYieldSource(address _source)`**  
  Returns the yield source data structure, including the underlying token, vault token, and max cap.
- **`getYieldSources()`**  
  Returns a list of all authorized yield sources in the system.
- **`getTotalCollateralsScaled()`**  
  Returns the total value of all collaterals managed by the Queue (both unlent and deposited in yield sources) scaled to 18 decimals.
- **`getCollateralsYieldSourceScaled(address _source)`**  
  Returns the total value of collaterals in a specific yield source, scaled to 18 decimals.

### 5.3 ParetoDollarStaking
**Key methods** (user-facing):  
- **`deposit(uint256 amount)`**  
  User stakes `amount` of USP to receive sUSP.  
- **`withdraw(uint256 sUSPAmount)`**  
  User unstakes `sUSPAmount` to retrieve USP, reflecting any accrued yield.   
- **`convertToAssets(uint256 sUSPAmount)`**  
  Returns how many underlying USP assets correspond to `sUSPAmount`, accounting for yield accrued.

---

## Collateral & Yield Sources

### 6.1 Collateral Tracking
`ParetoDollar` manages a list of valid collateral tokens (e.g., USDC, USDS, USDT), each scaled to 18 decimals internally. Collateral is 1:1 convertible into USP.

### 6.2 Yield Source Integration
- **Credit Vault (VaultType == 1)**  
  Uses interfaces like `IIdleCreditVault` or `IIdleCDOEpochVariant` for institutional-lending strategies.  
- **ERC4626 (VaultType == 2)**  
  Any standard ERC4626 vault. The Queue deposits or withdraws using calls like `deposit(uint256,address)` / `redeem(uint256,address,address)`.

### 6.3 Adding & Removing Yield Sources
Only the system’s Owner can add or remove yield sources. Each yield source stores:  
- The underlying stablecoin token (e.g., USDC).  
- The vault token (e.g. a share token or a Tranche token).  
- A `maxCap`.  
- A list of `allowedMethods[]` (e.g. `depositAA`, `withdrawAA`, etc.).

---

## FAQs & Implementation Details

- **How does the epoch-based redemption process work?**  
  All redemption requests that arrive before `stopEpoch` are grouped into the same epoch. The manager redeems enough collateral to fulfill those requests, then calls `stopEpoch` to end that epoch.

- **How is yield minted?**  
  The Queue calculates the total collateral value versus all outstanding USP plus reserved withdrawals. Any surplus is minted as new USP and deposited into the staking contract, boosting the sUSP/USP exchange rate.

- **When is `depositYield()` typically called?**  
  The manager calls it periodically (e.g., daily, weekly) to capture realized yield, mint new USP to the Queue, and deposit that yield into `ParetoDollarStaking`.

- **Can funds be moved between yield sources without redemption requests?**  
  Yes. The manager can rebalance funds at any time by redeeming from one source and depositing into another (using methods such as `redeemFunds` and `depositFunds`), even if there are no active user redemption requests.
